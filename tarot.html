<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MystAI â€” AI Tarot Reading</title>
  <link rel="icon" type="image/png" href="mystai-logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg-start:#081133;
      --bg-end:#050818;
      --accent:#f2c84b;
      --accent-soft:#ffd86b;
      --text:#e4e9ff;
      --muted:#a5afd6;
      --card-border:#f4d79a;
    }
    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 50% -15%, #1a2660 0, #050818 70%),
        radial-gradient(900px 600px at 0% 110%, #171f4f 0, #050818 70%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* ========== TOP BAR ========== */
    .topbar{
      position:sticky;
      top:0;
      z-index:20;
      padding:10px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:rgba(5,10,35,.88);
      backdrop-filter:blur(14px);
      border-bottom:1px solid rgba(255,255,255,.11);
      box-shadow:0 18px 35px rgba(0,0,0,.55);
    }
    .top-left,.top-right{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .lang-btn{
      border:none;
      border-radius:999px;
      width:34px;height:34px;
      cursor:pointer;
      background-size:cover;
      background-position:center;
      border:2px solid transparent;
      transition:transform .22s ease, box-shadow .22s ease, border-color .22s ease;
    }
    .lang-btn.flag-en{background-image:url("https://flagcdn.com/w40/gb.png");}
    .lang-btn.flag-tr{background-image:url("https://flagcdn.com/w40/tr.png");}
    .lang-btn:hover{transform:scale(1.08);}
    .lang-btn.active{
      box-shadow:0 0 14px rgba(242,200,75,.9);
      border-color:var(--accent);
      transform:scale(1.1);
    }

    .nav-btn{
      border:0;
      border-radius:22px;
      padding:6px 14px;
      font-size:13px;
      font-weight:600;
      color:#fff;
      background:rgba(255,255,255,.14);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:5px;
      transition:all .22s ease;
    }
    .nav-btn:hover{
      filter:brightness(1.2);
      transform:translateY(-1px);
    }

    .user-label{
      font-size:13px;
      color:#ffe780;
      text-shadow:0 0 12px rgba(242,200,75,.7);
      margin-right:4px;
    }

    /* ========== LAYOUT ========== */
    .wrapper{
      flex:1;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:26px 16px 40px;
    }

    .tarot-shell{
      width:100%;
      max-width:1180px;
      border-radius:24px;
      padding:24px 24px 26px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(circle at top,#1e285f 0,#050818 55%)
        border-box;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06),
        0 26px 60px rgba(0,0,0,.75);
      display:grid;
      grid-template-columns:minmax(0,1.15fr) minmax(0,1fr);
      gap:26px;
      position:relative;
      overflow:hidden;
    }

    .tarot-shell::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 15% 0%,rgba(255,255,255,.18),transparent 55%),
        radial-gradient(circle at 85% 100%,rgba(90,130,255,.28),transparent 55%);
      mix-blend-mode:screen;
      opacity:.35;
      pointer-events:none;
    }

    @media(max-width:980px){
      .tarot-shell{
        grid-template-columns:1fr;
      }
    }

    /* ========== LEFT: CARDS & FORM ========== */
    .left-panel{
      position:relative;
      z-index:1;
    }

    .page-title{
      font-family:"Cinzel",serif;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:var(--accent-soft);
      font-size:26px;
      text-shadow:0 0 18px rgba(242,200,75,.8);
      margin-bottom:6px;
    }
    .page-sub{
      font-size:14px;
      color:var(--muted);
      line-height:1.7;
      margin-bottom:18px;
    }

    .label{
      margin-top:12px;
      margin-bottom:6px;
      font-size:13px;
      font-weight:600;
      color:#ffe58b;
      text-align:left;
    }

    .cards-frame{
      border-radius:18px;
      padding:18px 16px 16px;
      background:radial-gradient(circle at top,#252f66,#070b23);
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 12px 30px rgba(0,0,0,.7);
      position:relative;
      overflow:hidden;
    }
    .cards-frame::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:conic-gradient(
        from 210deg,
        rgba(242,200,75,.0),
        rgba(242,200,75,.25),
        rgba(242,200,75,.0),
        rgba(160,120,255,.12),
        rgba(242,200,75,.0)
      );
      opacity:.55;
      mix-blend-mode:screen;
      animation:spinGlow 22s linear infinite;
      pointer-events:none;
    }
    @keyframes spinGlow{
      to{transform:rotate(360deg);}
    }

    .cards-row{
      display:flex;
      justify-content:center;
      align-items:flex-end;
      gap:18px;
      margin-top:4px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }

    .tarot-card{
      position:relative;
      width:120px;
      height:210px;
      perspective:1100px;
      cursor:pointer;
      transition:transform .22s ease, filter .22s ease;
    }
    .tarot-card.disabled{cursor:default;}

    .tarot-card:not(.disabled):hover{
      transform:translateY(-6px) scale(1.02);
      filter:drop-shadow(0 18px 30px rgba(0,0,0,.9));
    }

    .card-inner{
      position:relative;
      width:100%;
      height:100%;
      transform-style:preserve-3d;
      transition:transform .7s cubic-bezier(.22,.65,.25,1);
    }
    .tarot-card.flipped .card-inner{
      transform:rotateY(180deg);
    }

    .card-face{
      position:absolute;
      inset:0;
      border-radius:14px;
      overflow:hidden;
      backface-visibility:hidden;
      box-shadow:0 12px 26px rgba(0,0,0,.75);
      border:1px solid rgba(244,215,154,.9);
    }
    .card-back-face{
      background:#070b22 url("images/tarot/mystai-back.png") center/cover no-repeat;
    }
    .card-front-face{
      transform:rotateY(180deg);
      background:#050814;
      display:flex;
      flex-direction:column;
    }
    .card-front-face img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .card-caption{
      margin-top:8px;
      font-size:11px;
      color:var(--muted);
      text-align:center;
    }

    .card-caption span{
      font-weight:600;
      color:#ffe58b;
    }

    .hint{
      font-size:11px;
      color:#9aa6e6;
      margin-top:4px;
      text-align:left;
    }

    textarea{
      width:100%;
      min-height:86px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:#050821;
      color:#e7ecff;
      padding:10px 11px;
      font-size:14px;
      font-family:inherit;
      resize:vertical;
      outline:none;
      box-shadow:inset 0 0 12px rgba(0,0,0,.45);
    }
    textarea::placeholder{
      font-size:13px;
      color:#7f89c0;
    }

    .primary-btn{
      margin-top:14px;
      border:0;
      border-radius:14px;
      padding:10px 18px;
      font-size:14px;
      font-weight:800;
      cursor:pointer;
      background:linear-gradient(115deg,#ffd85b,#f2c84b,#ffed9a);
      color:#11121a;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow:
        0 0 24px rgba(242,200,75,.65),
        0 10px 26px rgba(0,0,0,.65);
      transition:all .2s ease;
    }
    .primary-btn:hover{
      transform:translateY(-1px) scale(1.02);
    }
    .primary-btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .status{
      margin-top:8px;
      font-size:12px;
      color:#b0b9ff;
      text-align:left;
      min-height:16px;
    }

    /* ========== RIGHT: RESULT PANEL ========== */
    .right-panel{
      position:relative;
      z-index:1;
    }

    .result-box{
      border-radius:18px;
      padding:16px 16px 14px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(circle at 10% 0%,rgba(255,255,255,.06),transparent 55%),
        radial-gradient(circle at 100% 100%,rgba(65,105,225,.28),transparent 55%),
        #050818;
      box-shadow:0 20px 40px rgba(0,0,0,.8);
      display:flex;
      flex-direction:column;
      height:100%;
    }

    .result-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:6px;
    }
    .result-title{
      font-size:15px;
      font-weight:700;
      color:#ffe58b;
    }
    .spread-tags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:3px;
      font-size:11px;
      color:#b8c0ff;
    }
    .pill{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(15,20,55,.7);
    }

    .audio-btn{
      border:0;
      border-radius:999px;
      padding:6px 12px;
      font-size:12px;
      font-weight:600;
      background:rgba(255,255,255,.16);
      color:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .audio-btn[disabled]{opacity:.45;cursor:not-allowed;}

    .result-content{
      margin-top:8px;
      font-size:14px;
      color:#dde4ff;
      line-height:1.8;
      overflow-y:auto;
      max-height:280px;
      padding-right:4px;
      white-space:pre-wrap;
    }
    .result-hint{
      font-size:11px;
      color:#8993d0;
      margin-top:8px;
    }

    /* ========== FOOTER ========== */
    footer{
      border-top:1px solid rgba(255,255,255,.07);
      padding:16px;
      text-align:center;
      font-size:13px;
      color:#9ea7cf;
      background:#050818;
    }
    footer a{
      color:#ffd86b;
      text-decoration:none;
      font-weight:600;
    }
    footer a:hover{
      color:#fff6be;
      text-shadow:0 0 10px rgba(255,246,190,.8);
    }
  </style>
</head>
<body>
  <!-- ===== TOP BAR ===== -->
  <div class="topbar">
    <div class="top-left">
      <button class="lang-btn flag-en" id="btn-en"></button>
      <button class="lang-btn flag-tr" id="btn-tr"></button>
    </div>
    <div class="top-right">
      <span class="user-label" id="userLabel"></span>
      <button class="nav-btn" id="backBtn">â¬… App</button>
      <button class="nav-btn" id="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- ===== MAIN CONTENT ===== -->
  <div class="wrapper">
    <div class="tarot-shell">
      <!-- LEFT -->
      <div class="left-panel">
        <h1 class="page-title" id="title">AI Tarot Reading</h1>
        <p class="page-sub" id="subtitle">
          Select three cards and set your intention. MystAI will read your Past, Present and Future through tarot archetypes.
        </p>

        <div class="label" id="labelCards">Choose 3 Cards (Past â€“ Present â€“ Future)</div>

        <div class="cards-frame">
          <div class="cards-row" id="cardsRow">
            <!-- PAST -->
            <div class="tarot-card" data-pos="past">
              <div class="card-inner">
                <div class="card-face card-back-face"></div>
                <div class="card-face card-front-face">
                  <img data-role="img" src="" alt="Tarot card" />
                </div>
              </div>
              <div class="card-caption">
                <span id="capPast">Past</span> Â· <span data-role="cardName"></span>
              </div>
            </div>

            <!-- PRESENT -->
            <div class="tarot-card" data-pos="present">
              <div class="card-inner">
                <div class="card-face card-back-face"></div>
                <div class="card-face card-front-face">
                  <img data-role="img" src="" alt="Tarot card" />
                </div>
              </div>
              <div class="card-caption">
                <span id="capPresent">Present</span> Â· <span data-role="cardName"></span>
              </div>
            </div>

            <!-- FUTURE -->
            <div class="tarot-card" data-pos="future">
              <div class="card-inner">
                <div class="card-face card-back-face"></div>
                <div class="card-face card-front-face">
                  <img data-role="img" src="" alt="Tarot card" />
                </div>
              </div>
              <div class="card-caption">
                <span id="capFuture">Future</span> Â· <span data-role="cardName"></span>
              </div>
            </div>
          </div>

          <div class="hint" id="cardHint">
            Click each card one by one. The MystAI backs will flip and reveal the card chosen for you.
          </div>
        </div>

        <div class="label" id="labelQuestion">Your Question / Intention</div>
        <textarea id="tarotQuestion"
          placeholder="Write what youâ€™d like MystAI to focus on (love, relationships, career, spiritual path...)"></textarea>

        <button class="primary-btn" id="readBtn" disabled>
          ðŸ”® <span id="readBtnText">Reveal My Tarot Reading</span>
        </button>

        <div class="status" id="statusText"></div>
      </div>

      <!-- RIGHT -->
      <div class="right-panel">
        <div class="result-box">
          <div class="result-header">
            <div>
              <div class="result-title" id="resultTitle">Your Tarot Spread</div>
              <div class="spread-tags">
                <span class="pill" id="lblPast">Past</span>
                <span class="pill" id="lblPresent">Present</span>
                <span class="pill" id="lblFuture">Future</span>
              </div>
            </div>
            <button class="audio-btn" id="listenBtn" disabled>
              ðŸ”Š <span id="listenLabel">Listen</span>
            </button>
          </div>

          <div class="result-content" id="resultText">
            âœ¨ After you choose 3 cards and send your intention, MystAI will reveal your tarot reading here. âœ¨
          </div>

          <div class="result-hint" id="resultHint">
            MystAI is an AI-based entertainment tool and should not be taken as professional, financial or medical advice.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== FOOTER ===== -->
  <footer>
    <p>
      Â© 2025 MystAI.ai â€”
      <span id="rightsLabel">All Rights Reserved.</span>
      <span id="devLabel">Developed by GALAXY ðŸŒŒ</span><br />
      <span id="contactLabel">Contact us:</span>
      <a href="mailto:support@mystai.ai">support@mystai.ai</a>
    </p>
  </footer>

  <audio id="audioPlayer" style="display:none;"></audio>

  <!-- ===== SCRIPT ===== -->
  <script type="module">
    /* ===== CONFIG ===== */
    const BACKEND_URL = "https://mystai-international-1.onrender.com";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDyiD7GAfOjMbtm-S6pO6XCSRXJclffPL0",
      authDomain: "mystai-6cca2.firebaseapp.com",
      projectId: "mystai-6cca2",
      storageBucket: "mystai-6cca2.appspot.com",
      messagingSenderId: "624127781219",
      appId: "1:624127781219:web:a580ac6e80ccc26e694b56"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ===== ELEMENTS ===== */
    const btnEn       = document.getElementById("btn-en");
    const btnTr       = document.getElementById("btn-tr");
    const backBtn     = document.getElementById("backBtn");
    const logoutBtn   = document.getElementById("logoutBtn");
    const userLabel   = document.getElementById("userLabel");

    const titleEl     = document.getElementById("title");
    const subtitleEl  = document.getElementById("subtitle");
    const labelCards  = document.getElementById("labelCards");
    const cardHint    = document.getElementById("cardHint");
    const labelQuestion = document.getElementById("labelQuestion");
    const tarotQuestion = document.getElementById("tarotQuestion");
    const readBtn     = document.getElementById("readBtn");
    const readBtnText = document.getElementById("readBtnText");
    const statusText  = document.getElementById("statusText");

    const resultTitle = document.getElementById("resultTitle");
    const resultText  = document.getElementById("resultText");
    const resultHint  = document.getElementById("resultHint");
    const listenBtn   = document.getElementById("listenBtn");
    const listenLabel = document.getElementById("listenLabel");
    const audioPlayer = document.getElementById("audioPlayer");

    const rightsLabel  = document.getElementById("rightsLabel");
    const devLabel     = document.getElementById("devLabel");
    const contactLabel = document.getElementById("contactLabel");

    const cardsRow   = document.getElementById("cardsRow");
    const cardElems  = Array.from(cardsRow.querySelectorAll(".tarot-card"));
    const capPast    = document.getElementById("capPast");
    const capPresent = document.getElementById("capPresent");
    const capFuture  = document.getElementById("capFuture");
    const lblPast    = document.getElementById("lblPast");
    const lblPresent = document.getElementById("lblPresent");
    const lblFuture  = document.getElementById("lblFuture");

    /* ===== TAROT DECK (major arcana Ã¶rneÄŸi) ===== */
    const TAROT_CARDS = [
      { id:"the-fool", name:"The Fool" },
      { id:"the-magician", name:"The Magician" },
      { id:"the-high-priestess", name:"The High Priestess" },
      { id:"the-empress", name:"The Empress" },
      { id:"the-emperor", name:"The Emperor" },
      { id:"the-hierophant", name:"The Hierophant" },
      { id:"the-lovers", name:"The Lovers" },
      { id:"the-chariot", name:"The Chariot" },
      { id:"strength", name:"Strength" },
      { id:"the-hermit", name:"The Hermit" },
      { id:"wheel-of-fortune", name:"Wheel of Fortune" },
      { id:"justice", name:"Justice" },
      { id:"the-hanged-man", name:"The Hanged Man" },
      { id:"death", name:"Death" },
      { id:"temperance", name:"Temperance" },
      { id:"the-devil", name:"The Devil" },
      { id:"the-tower", name:"The Tower" },
      { id:"the-star", name:"The Star" },
      { id:"the-moon", name:"The Moon" },
      { id:"the-sun", name:"The Sun" },
      { id:"judgement", name:"Judgement" },
      { id:"the-world", name:"The World" }
    ];

    // SeÃ§ilen kartlar: { past: {cardObj}, present:{}, future:{} }
    let selectedCards = {};
    let activeLang = localStorage.getItem("myst_lang") || "tr";

    /* ===== i18n ===== */
    const i18n = {
      en:{
        title:"AI Tarot Reading",
        subtitle:"Select three cards and set your intention. MystAI will read your past, present and future through tarot archetypes.",
        cardsLabel:"Choose 3 Cards (Past â€“ Present â€“ Future)",
        cardHint:"Click each card one by one. The MystAI backs will flip and reveal the card chosen for you.",
        capPast:"Past",
        capPresent:"Present",
        capFuture:"Future",
        questionLabel:"Your Question / Intention",
        placeholder:"Write what youâ€™d like MystAI to focus on (love, relationships, career, spiritual path...)",
        btnText:"Reveal My Tarot Reading",
        statusIdle:"",
        statusNeedCards:"Please select 3 cards first.",
        statusNeedText:"Please write at least a short question or intention.",
        statusLoading:"Shuffling the deck and reading your spread...",
        statusDone:"Your tarot reading is ready.",
        statusError:"An error occurred. Please try again.",
        resultTitle:"Your Tarot Spread",
        resultInitial:"âœ¨ After you choose 3 cards and send your intention, MystAI will reveal your tarot reading here. âœ¨",
        resultHint:"MystAI is an AI-based entertainment tool and should not be taken as professional, financial or medical advice.",
        listen:"Listen",
        listening:"Playing...",
        back:"Back to App",
        logout:"Logout",
        lblPast:"Past",
        lblPresent:"Present",
        lblFuture:"Future",
        rights:"All Rights Reserved.",
        dev:"Developed by GALAXY ðŸŒŒ",
        contact:"Contact us:",
        userWelcome:"Welcome, "
      },
      tr:{
        title:"Yapay ZekÃ¢ Tarot AÃ§Ä±lÄ±mÄ±",
        subtitle:"ÃœÃ§ kart seÃ§ ve niyetini yaz. MystAI, geÃ§miÅŸâ€“ÅŸimdiâ€“gelecek enerjini tarot arketipleriyle yorumlasÄ±n.",
        cardsLabel:"3 Kart SeÃ§ (GeÃ§miÅŸ â€“ Åžimdi â€“ Gelecek)",
        cardHint:"Kartlara teker teker tÄ±kla. MystAI kart arkalarÄ± dÃ¶necek ve senin iÃ§in seÃ§ilen kartlarÄ± gÃ¶sterecek.",
        capPast:"GeÃ§miÅŸ",
        capPresent:"Åžimdi",
        capFuture:"Gelecek",
        questionLabel:"Sorun / Niyetin",
        placeholder:"AÅŸk, iliÅŸkiler, kariyer veya ruhsal yolculuÄŸunla ilgili merak ettiklerini buraya yaz...",
        btnText:"Tarot AÃ§Ä±lÄ±mÄ±mÄ± GÃ¶ster",
        statusIdle:"",
        statusNeedCards:"LÃ¼tfen Ã¶nce 3 kart seÃ§.",
        statusNeedText:"LÃ¼tfen en azÄ±ndan kÄ±sa bir soru veya niyet yaz.",
        statusLoading:"Deste karÄ±lÄ±yor, enerjin kartlara yansÄ±yor...",
        statusDone:"Tarot aÃ§Ä±lÄ±mÄ±n hazÄ±r.",
        statusError:"Bir hata oluÅŸtu. LÃ¼tfen tekrar dene.",
        resultTitle:"Tarot AÃ§Ä±lÄ±mÄ±n",
        resultInitial:"âœ¨ 3 kartÄ±nÄ± seÃ§ip niyetini yazdÄ±ktan sonra yapay zekÃ¢ tarot yorumun burada gÃ¶rÃ¼necek. âœ¨",
        resultHint:"MystAI eÄŸlence amaÃ§lÄ± bir yapay zekÃ¢ fal yorumlayÄ±cÄ±sÄ±dÄ±r; profesyonel, finansal veya tÄ±bbi tavsiye yerine geÃ§mez.",
        listen:"Dinle",
        listening:"Ã‡alÄ±yor...",
        back:"Uygulamaya DÃ¶n",
        logout:"Ã‡Ä±kÄ±ÅŸ Yap",
        lblPast:"GeÃ§miÅŸ",
        lblPresent:"Åžimdi",
        lblFuture:"Gelecek",
        rights:"TÃ¼m HaklarÄ± SaklÄ±dÄ±r.",
        dev:"GALAXY tarafÄ±ndan geliÅŸtirilmiÅŸtir ðŸŒŒ",
        contact:"Ä°letiÅŸim:",
        userWelcome:"HoÅŸ geldin, "
      }
    };

    function applyLang(lang){
      activeLang = lang;
      localStorage.setItem("myst_lang",lang);
      const t = i18n[lang];

      titleEl.textContent       = t.title;
      subtitleEl.textContent    = t.subtitle;
      labelCards.textContent    = t.cardsLabel;
      cardHint.textContent      = t.cardHint;
      labelQuestion.textContent = t.questionLabel;
      tarotQuestion.placeholder = t.placeholder;
      readBtnText.textContent   = t.btnText;

      resultTitle.textContent   = t.resultTitle;
      resultHint.textContent    = t.resultHint;
      rightsLabel.textContent   = t.rights;
      devLabel.textContent      = t.dev;
      contactLabel.textContent  = t.contact;
      listenLabel.textContent   = t.listen;
      lblPast.textContent       = t.lblPast;
      lblPresent.textContent    = t.lblPresent;
      lblFuture.textContent     = t.lblFuture;
      capPast.textContent       = t.capPast;
      capPresent.textContent    = t.capPresent;
      capFuture.textContent     = t.capFuture;

      backBtn.textContent   = "â¬… " + t.back;
      logoutBtn.textContent = t.logout;

      btnEn.classList.toggle("active",lang==="en");
      btnTr.classList.toggle("active",lang==="tr");

      if(auth.currentUser){
        const name = auth.currentUser.displayName || auth.currentUser.email;
        userLabel.textContent = t.userWelcome + name;
      }

      // EÄŸer henÃ¼z fal yoksa, baÅŸlangÄ±Ã§ mesajÄ±nÄ± gÃ¼ncelle
      if(!resultText.dataset.filled){
        resultText.textContent = t.resultInitial;
      }
    }

    btnEn.addEventListener("click",()=>applyLang("en"));
    btnTr.addEventListener("click",()=>applyLang("tr"));

    backBtn.addEventListener("click",()=>{ window.location.href="app.html"; });
    logoutBtn.addEventListener("click",()=>{ signOut(auth).then(()=>window.location.href="login.html"); });

    onAuthStateChanged(auth,(user)=>{
      if(!user){
        window.location.href="login.html";
        return;
      }
      const t = i18n[activeLang];
      const name = user.displayName || user.email;
      userLabel.textContent = t.userWelcome + name;
    });

    applyLang(activeLang);

    /* ===== CARD LOGIC ===== */
    function drawRandomCard(){
      const usedIds = Object.values(selectedCards).map(c=>c.id);
      const available = TAROT_CARDS.filter(c=>!usedIds.includes(c.id));
      if(!available.length) return null;
      const idx = Math.floor(Math.random()*available.length);
      return available[idx];
    }

    function updateReadButtonState(){
      const allPositions = ["past","present","future"];
      const full = allPositions.every(p=>selectedCards[p]);
      readBtn.disabled = !full;
      if(!full){
        statusText.textContent = i18n[activeLang].statusNeedCards;
      }else{
        statusText.textContent = i18n[activeLang].statusIdle;
      }
    }

    cardElems.forEach(card=>{
      const pos = card.getAttribute("data-pos"); // past/present/future
      const imgEl   = card.querySelector("[data-role='img']");
      const nameEl  = card.querySelector("[data-role='cardName']");

      card.addEventListener("click",()=>{
        if(selectedCards[pos]) return; // zaten seÃ§ildi
        const cardObj = drawRandomCard();
        if(!cardObj) return;

        selectedCards[pos] = cardObj;

        const imgPath = `images/tarot/cards/${cardObj.id}.png`;
        imgEl.src = imgPath;
        imgEl.alt = cardObj.name;
        nameEl.textContent = cardObj.name;

        card.classList.add("flipped","disabled");
        updateReadButtonState();
      });
    });

    /* ===== BACKEND & FIRESTORE ===== */
    readBtn.addEventListener("click",async()=>{
      const t = i18n[activeLang];
      const user = auth.currentUser;
      if(!user){
        alert(activeLang==="tr" ? "LÃ¼tfen Ã¶nce giriÅŸ yap." : "Please log in first.");
        return;
      }

      const positions = ["past","present","future"];
      const allSelected = positions.every(p=>selectedCards[p]);
      if(!allSelected){
        alert(t.statusNeedCards);
        return;
      }

      const question = tarotQuestion.value.trim();
      if(!question){
        alert(t.statusNeedText);
        return;
      }

      readBtn.disabled = true;
      statusText.textContent = t.statusLoading;
      resultText.textContent = "";
      resultText.dataset.filled = "true";
      listenBtn.disabled = true;
      audioPlayer.pause();
      audioPlayer.currentTime = 0;
      audioPlayer.src = "";

      try{
        if(!BACKEND_URL || BACKEND_URL.includes("YOUR-BACKEND-URL")){
          statusText.textContent = "Backend URL is not configured.";
          readBtn.disabled = false;
          return;
        }

        const cardsDesc = positions.map(pos=>{
          const c = selectedCards[pos];
          const label =
            pos==="past"    ? (activeLang==="tr"?"GeÃ§miÅŸ":"Past") :
            pos==="present" ? (activeLang==="tr"?"Åžimdi":"Present") :
                              (activeLang==="tr"?"Gelecek":"Future");
          return `${label}: ${c.name}`;
        }).join("\n");

        const systemPrompt =
          activeLang==="tr"
            ? "Sen MystAI adÄ±nda sezgisel ve net konuÅŸan deneyimli bir tarot yorumcususun. GeÃ§miÅŸ-ÅŸimdi-gelecek aÃ§Ä±lÄ±mÄ±nÄ± derin ama kullanÄ±cÄ±yÄ± korkutmadan, samimi ve yapÄ±cÄ± bir dille yorumla."
            : "You are an experienced tarot reader named MystAI. Interpret the pastâ€“presentâ€“future spread in a warm, mystical and empowering way without scaring the user.";

        const userText =
          (activeLang==="tr"
            ? "Bu bir tarot aÃ§Ä±lÄ±mÄ±dÄ±r.\nKartlarÄ± ve kullanÄ±cÄ±nÄ±n niyetini yorumla.\n\nKartlar:\n"
            : "This is a tarot spread.\nInterpret the drawn cards and the user's intention.\n\nCards:\n") +
          cardsDesc +
          "\n\n" +
          (activeLang==="tr"
            ? "KullanÄ±cÄ±nÄ±n sorusu/niyeti: "
            : "User's question/intention: ") +
          question;

        const payload = {
          user_input: `${systemPrompt}\n\n${userText}`
        };

        const res = await fetch(`${BACKEND_URL}/predict`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify(payload)
        });

        if(!res.ok){
          throw new Error("HTTP " + res.status);
        }

        const data = await res.json();
        const text = data?.text || (activeLang==="tr" ? "YanÄ±t alÄ±namadÄ±." : "No response.");
        const audioPath = data?.audio;

        resultText.textContent = text;
        statusText.textContent = t.statusDone;

        // Firestore'a kaydet
        try{
          await addDoc(collection(db,"fortunes"),{
            user: user.email,
            type: "AI Tarot Reading",
            question,
            result: text,
            cards: selectedCards,
            createdAt: new Date().toISOString(),
            source: "tarot-page"
          });
        }catch(err){
          console.warn("Firestore save error:",err);
        }

        if(audioPath){
          const fullURL = audioPath.startsWith("http") ? audioPath : `${BACKEND_URL}${audioPath}`;
          audioPlayer.src = fullURL;
          listenBtn.disabled = false;
        }
      }catch(err){
        console.error(err);
        statusText.textContent = t.statusError;
        resultText.textContent =
          (activeLang==="tr" ? "Hata: " : "Error: ") + (err?.message || String(err));
      }finally{
        readBtn.disabled = false;
      }
    });

    listenBtn.addEventListener("click",()=>{
      if(!audioPlayer.src) return;
      const t = i18n[activeLang];
      listenLabel.textContent = t.listening;
      audioPlayer.play().catch(()=>{});
      audioPlayer.onended = ()=>{ listenLabel.textContent = t.listen; };
    });
  </script>
</body>
</html>
