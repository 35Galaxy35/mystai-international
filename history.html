<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MystAI — My Reading History</title>
  <link rel="icon" type="image/png" href="mystai-logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet">

  <style>
    body {
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:radial-gradient(1100px 700px at 50% -10%, #101a4d 0%, #0b0f1f 80%);
      color:#e6ecff;
      text-align:center;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      display:flex;
      justify-content:flex-end;
      padding:15px 25px;
      gap:10px;
    }
    .lang-btn{
      width:36px;height:36px;
      border-radius:50%;
      border:none;
      background-size:cover;
      cursor:pointer;
    }
    .flag-en{background-image:url('https://flagcdn.com/w40/gb.png');}
    .flag-tr{background-image:url('https://flagcdn.com/w40/tr.png');}

    .btn{
      background:rgba(255,255,255,.12);
      color:white;
      padding:8px 16px;
      border-radius:20px;
      border:none;
      cursor:pointer;
      font-weight:600;
    }

    h1{
      font-family:'Cinzel',serif;
      color:#ffd54f;
      margin-top:20px;
      text-shadow:0 0 12px rgba(255,215,0,.4);
    }

    #historyList{
      width:100%;
      max-width:760px;
      margin:30px auto;
    }

    .item{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:15px;
      margin-bottom:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:15px;
    }

    .info{text-align:left;}
    .type{font-weight:700;color:#ffd54f;}
    .date{font-size:13px;color:#c7ceff;}

    .see-btn{
      background:linear-gradient(120deg,#ffd700,#ffe680);
      color:#111;
      padding:7px 14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:700;
      margin-right:8px;
    }

    .del-btn{
      background:#e04747;
      color:white;
      padding:7px 14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:700;
    }

    footer{
      margin-top:auto;
      padding:25px;
      color:#aeb6d0;
      font-size:13px;
      border-top:1px solid rgba(255,255,255,.1);
    }

    /* Modal */
    #modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.7);
      justify-content:center;
      align-items:center;
      z-index:2000;
    }
    #modalBox{
      background:#0b132a;
      border-radius:12px;
      padding:20px;
      width:90%;
      max-width:650px;
      border:1px solid rgba(255,255,255,.12);
      text-align:left;
      color:#e6ecff;
      white-space:pre-wrap;
      position:relative;
    }

    #closeModal{
      background:#ffd54f;
      border:none;
      padding:6px 12px;
      border-radius:6px;
      font-weight:700;
      cursor:pointer;
      margin-top:12px;
    }

    #modalCloseX{
      position:absolute;
      top:10px;
      right:10px;
      background:#ffd54f;
      border:none;
      width:28px;
      height:28px;
      border-radius:50%;
      cursor:pointer;
      font-weight:900;
    }
  </style>
</head>

<body>

<header>
  <button class="lang-btn flag-en" id="btn-en"></button>
  <button class="lang-btn flag-tr" id="btn-tr"></button>
  <button class="btn" id="backBtn">⬅ App</button>
  <button class="btn" id="logoutBtn">Logout</button>
</header>

<h1 id="title">My Reading History</h1>
<div id="historyList"></div>

<footer>
  © 2025 MystAI.ai — <span id="rights">All Rights Reserved.</span>
</footer>

<!-- Modal -->
<div id="modal">
  <div id="modalBox">
    <button id="modalCloseX">X</button>
    <div id="modalText"></div>
  </div>
</div>

<script type="module">

  /* FIREBASE */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, collectionGroup, query, where, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDyiD7GAfOjMbtm-S6pO6XCSRXJclffPL0",
    authDomain: "mystai-6cca2.firebaseapp.com",
    projectId: "mystai-6cca2",
    storageBucket: "mystai-6cca2.appspot.com",
    messagingSenderId: "624127781219",
    appId: "1:624127781219:web:a580ac6e80ccc26e694b56"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /* ELEMENTS */
  const list = document.getElementById("historyList");
  const modal = document.getElementById("modal");
  const modalText = document.getElementById("modalText");
  const modalCloseX = document.getElementById("modalCloseX");

  /* LANG */
  const btnEn = document.getElementById("btn-en");
  const btnTr = document.getElementById("btn-tr");
  let lang = localStorage.getItem("myst_lang") || "en";

  const dict = {
    en:{title:"My Reading History", rights:"All Rights Reserved.", back:"⬅ App", logout:"Logout", see:"See", del:"Delete"},
    tr:{title:"Fal Geçmişim", rights:"Tüm Hakları Saklıdır.", back:"⬅ Geri", logout:"Çıkış", see:"Falı Gör", del:"Sil"}
  };

  function applyLang(){
    const t=dict[lang];
    document.getElementById("title").textContent=t.title;
    document.getElementById("rights").textContent=t.rights;
    document.getElementById("backBtn").textContent=t.back;
    document.getElementById("logoutBtn").textContent=t.logout;
  }

  btnEn.onclick=()=>{lang="en";localStorage.setItem("myst_lang","en");applyLang();location.reload();}
  btnTr.onclick=()=>{lang="tr";localStorage.setItem("myst_lang","tr");applyLang();location.reload();}
  applyLang();

  modalCloseX.onclick=()=>{modal.style.display="none";};

  /* Geri */
  document.getElementById("backBtn").onclick=()=>location.href="app.html";

  /* Logout */
  document.getElementById("logoutBtn").onclick=()=>signOut(auth).then(()=>location.href="login.html");

  /* LOAD HISTORY */
  onAuthStateChanged(auth, async user=>{
    if(!user){location.href="login.html";return;}

    list.innerHTML="";

    const q=query(collectionGroup(db,"fortunes"), where("user","==",user.email));
    const snap=await getDocs(q);

    if(snap.empty){
      list.innerHTML="<p>Fal bulunamadı.</p>";
      return;
    }

    const records=[];
    snap.forEach(d=>records.push({...d.data(), id:d.id, path:d.ref.path}));

    records.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

    records.forEach(rec=>{
      const div=document.createElement("div");
      div.className="item";

      const t=dict[lang];

      div.innerHTML=`
        <div class="info">
          <div class="type">${rec.type}</div>
          <div class="date">${rec.createdAt}</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="see-btn">${t.see}</button>
          <button class="del-btn">${t.del}</button>
        </div>
      `;

      /* Falı gör */
      div.querySelector(".see-btn").onclick=()=>{
        modalText.textContent=rec.result;
        modal.style.display="flex";
      };

      /* Silme */
      div.querySelector(".del-btn").onclick=async()=>{
        if(!confirm(lang==="tr" ? "Bu falı silmek istediğine emin misin?" : "Are you sure to delete this reading?"))
          return;

        await deleteDoc(doc(db, rec.path));
        div.remove();
      };

      list.appendChild(div);
    });
  });

</script>
</body>
</html>
