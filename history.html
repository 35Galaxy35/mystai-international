<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fal Ge√ßmi≈üim</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Poppins", sans-serif;
            background: linear-gradient(to bottom, #001f3f, #001530);
            color: white;
            text-align: center;
        }

        h1 {
            margin-top: 40px;
            font-size: 38px;
            letter-spacing: 2px;
            font-weight: bold;
            color: #f7d774;
        }

        .history-list {
            max-width: 800px;
            margin: 40px auto;
        }

        .item {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info {
            text-align: left;
        }

        .btn-view, .btn-delete {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-view {
            background: #ffcc33;
            margin-right: 10px;
        }

        .btn-delete {
            background: rgba(255,0,0,0.7);
            color: white;
        }

        .lang {
            position: absolute;
            top: 15px;
            left: 15px;
        }

        .lang img {
            width: 36px;
            cursor: pointer;
            margin-right: 10px;
        }

        .top-right {
            position: absolute;
            top: 15px;
            right: 20px;
        }

        .top-right button {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <!-- Dil Deƒüi≈ütirme -->
    <div class="lang">
        <img src="img/en.png" id="btnEN">
        <img src="img/tr.png" id="btnTR">
    </div>

    <!-- Saƒü √úst -->
    <div class="top-right">
        <button id="backBtn">‚Üê Geri</button>
        <button id="logoutBtn">√áƒ±kƒ±≈ü</button>
    </div>

    <h1 id="pageTitle">FAL GE√áMƒ∞≈ûƒ∞M</h1>

    <div class="history-list" id="list"></div>

    <p id="emptyState" style="display:none; margin-top:40px; color:#ccc;">
        Kayƒ±t bulunamadƒ±.
    </p>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { 
            getFirestore, collection, getDocs, deleteDoc, doc 
        } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
        import {
            getAuth, onAuthStateChanged, signOut
        } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

        /* ==============================
           FIREBASE CONFIG
        =============================== */
        const firebaseConfig = {
            apiKey: "AIzaSyDyID7qAFOjMbtn-S6Op60X5RKCJc1FFpU",
            authDomain: "mystai-6cca2.firebaseapp.com",
            projectId: "mystai-6cca2",
            storageBucket: "mystai-6cca2.appspot.com",
            messagingSenderId: "624127781219",
            appId: "1:624127781219:web:a580ca6e806cc26e694056"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const listEl = document.getElementById("list");
        const emptyState = document.getElementById("emptyState");

        /* ==========================================
           TARƒ∞H NORMALƒ∞ZE (STRING + TIMESTAMP FIX)
        =========================================== */
        function normalizeDate(createdAt) {
            if (!createdAt) return new Date(0);
            if (createdAt.seconds) return new Date(createdAt.seconds * 1000);
            return new Date(createdAt);
        }

        /* ==========================================
            KAYITLARI GETƒ∞R
        =========================================== */
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html";
                return;
            }

            const ref = collection(db, "fortunes");
            const snap = await getDocs(ref);

            let items = [];

            snap.forEach(docSnap => {
                const d = docSnap.data();
                if (d.user === user.email) {
                    items.push({
                        id: docSnap.id,
                        ...d,
                        createdAtFix: normalizeDate(d.createdAt)
                    });
                }
            });

            // Tarihe g√∂re kesin doƒüru sƒ±ralama
            items.sort((a, b) => b.createdAtFix - a.createdAtFix);

            if (items.length === 0) {
                emptyState.style.display = "block";
                return;
            }

            // Listeyi bastƒ±r
            listEl.innerHTML = "";
            items.forEach(item => {
                const div = document.createElement("div");
                div.className = "item";

                div.innerHTML = `
                    <div class="info">
                        <div style="font-weight:600">T√ºr: ${item.type}</div>
                        <div>Tarih: ${item.createdAtFix.toLocaleString()}</div>
                    </div>

                    <div>
                        <button class="btn-view" onclick="location.href='view.html?id=${item.id}'">Falƒ±nƒ± G√∂r</button>
                        <button class="btn-delete" onclick="deleteItem('${item.id}')">üóë</button>
                    </div>
                `;

                listEl.appendChild(div);
            });
        });

        /* ==========================================
            KAYIT Sƒ∞L
        =========================================== */
        window.deleteItem = async function(id) {
            if (!confirm("Bu fal kaydƒ±nƒ± silmek istediƒüinize emin misiniz?")) return;

            await deleteDoc(doc(db, "fortunes", id));
            location.reload();
        };

        /* ==========================================
            GERƒ∞ VE √áIKI≈û
        =========================================== */
        backBtn.onclick = () => window.location.href = "app.html";
        logoutBtn.onclick = () => signOut(auth);

        /* ==========================================
            LANG SWITCH
        =========================================== */
        btnEN.onclick = () => {
            localStorage.setItem("lang", "en");
            location.reload();
        };

        btnTR.onclick = () => {
            localStorage.setItem("lang", "tr");
            location.reload();
        };

        // Dili uygula
        const lang = localStorage.getItem("lang") || "tr";
        if (lang === "en") {
            pageTitle.textContent = "MY READING HISTORY";
            backBtn.textContent = "Back";
            logoutBtn.textContent = "Logout";
        } else {
            pageTitle.textContent = "FAL GE√áMƒ∞≈ûƒ∞M";
            backBtn.textContent = "‚Üê Geri";
            logoutBtn.textContent = "√áƒ±kƒ±≈ü";
        }
    </script>
</body>
</html>
