<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MystAI â€” My Reading History</title>
  <link rel="icon" type="image/png" href="mystai-logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg1:#05091e;
      --bg2:#060b30;
      --card:#0c173c;
      --card2:#0c183f;
      --gold:#f6d36b;
      --gold-soft:#ffeaa0;
      --red:#ff5b66;
      --text:#dde4ff;
      --muted:#9fa8d6;
    }
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:radial-gradient(1300px 800px at 50% -10%, #182561 0%, #050818 65%, #02030a 100%);
      color:var(--text);
      display:flex;
      flex-direction:column;
    }

    /* Top bar */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 24px;
      background:rgba(5,10,35,.82);
      backdrop-filter:blur(14px);
      border-bottom:1px solid rgba(255,255,255,.1);
      position:sticky;
      top:0;
      z-index:20;
    }
    .top-left,.top-right{display:flex;align-items:center;gap:10px;}

    .flag-btn{
      border:none;
      width:32px;height:32px;
      border-radius:50%;
      background-size:cover;
      background-position:center;
      cursor:pointer;
      outline:none;
      transition:transform .2s, box-shadow .2s, border-color .2s;
      border:2px solid transparent;
    }
    .flag-en{background-image:url("https://flagcdn.com/w40/gb.png");}
    .flag-tr{background-image:url("https://flagcdn.com/w40/tr.png");}
    .flag-btn.active{
      transform:scale(1.06);
      box-shadow:0 0 12px rgba(246,211,107,.9);
      border-color:var(--gold);
    }

    .user-label{
      font-size:13px;
      color:var(--gold-soft);
      text-shadow:0 0 8px rgba(246,211,107,.35);
      margin-right:6px;
    }

    .nav-btn{
      border:none;
      border-radius:20px;
      padding:7px 14px;
      font-size:13px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:4px;
      background:rgba(255,255,255,.12);
      color:#fff;
      font-weight:600;
      transition:all .2s;
    }
    .nav-btn:hover{
      filter:brightness(1.07);
      transform:translateY(-1px);
    }

    /* Main */
    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:32px 12px 40px;
    }

    .title{
      font-family:'Cinzel',serif;
      font-size:32px;
      letter-spacing:2px;
      color:var(--gold);
      text-shadow:0 0 16px rgba(250,222,140,.55);
      margin-bottom:26px;
      text-align:center;
    }

    .list{
      width:100%;
      max-width:840px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .empty{
      text-align:center;
      color:var(--muted);
      font-size:15px;
      margin-top:30px;
    }

    .item{
      background:linear-gradient(135deg, rgba(12,24,70,.96), rgba(7,18,60,.96));
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      padding:12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 0 22px rgba(0,0,0,.55);
      gap:14px;
    }
    .item-main{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:13px;
    }
    .item-type{
      font-weight:700;
      color:var(--gold-soft);
    }
    .item-date{
      color:var(--muted);
      font-size:12px;
    }

    .item-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-shrink:0;
    }

    .btn-see{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:12px;
      font-weight:700;
      cursor:pointer;
      background:linear-gradient(120deg,#ffd700,#ffbf2f,#ffe680);
      color:#111;
      box-shadow:0 0 14px rgba(255,215,0,.55);
      transition:all .2s;
      white-space:nowrap;
    }
    .btn-see:hover{transform:translateY(-1px) scale(1.02);}

    .btn-del{
      border:none;
      border-radius:999px;
      width:30px;height:30px;
      cursor:pointer;
      background:radial-gradient(circle at 30% 30%,#ffb6b9,#ff5b66);
      box-shadow:0 0 12px rgba(255,91,102,.75);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:900;
      font-size:15px;
      transition:transform .2s, box-shadow .2s;
    }
    .btn-del:hover{
      transform:scale(1.05);
      box-shadow:0 0 16px rgba(255,91,102,1);
    }

    /* Footer */
    footer{
      border-top:1px solid rgba(255,255,255,.08);
      padding:16px 10px 18px;
      text-align:center;
      font-size:13px;
      color:var(--muted);
    }
    footer a{
      color:var(--gold-soft);
      text-decoration:none;
      font-weight:600;
    }
    footer a:hover{
      color:#fff9c2;
      text-shadow:0 0 10px rgba(255,249,194,.75);
    }

    @media(max-width:640px){
      .item{
        flex-direction:column;
        align-items:flex-start;
      }
      .item-actions{
        align-self:flex-end;
      }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="top-left">
      <button id="btn-en" class="flag-btn flag-en"></button>
      <button id="btn-tr" class="flag-btn flag-tr"></button>
    </div>
    <div class="top-right">
      <span id="user-label" class="user-label"></span>
      <button id="backBtn" class="nav-btn">â¬… Back</button>
      <button id="logoutBtn" class="nav-btn">Logout</button>
    </div>
  </header>

  <main class="main">
    <h1 id="pageTitle" class="title">MY READING HISTORY</h1>
    <section id="list" class="list"></section>
    <div id="emptyState" class="empty" style="display:none;">
      No readings found yet.
    </div>
  </main>

  <footer>
    Â© 2025 MystAI.ai â€” <span id="rightsLabel">All Rights Reserved.</span>
    <span id="devLabel">Developed by GALAXY ðŸŒŒ</span><br />
    <span id="contactLabel">Contact us:</span>
    <a href="mailto:support@mystai.ai">support@mystai.ai</a>
  </footer>

  <script type="module">
    /* ===== Firebase setup ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      getDocs,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDyiD7GAfOjMbtm-S6pO6XCSRXJclffPL0",
      authDomain: "mystai-6cca2.firebaseapp.com",
      projectId: "mystai-6cca2",
      storageBucket: "mystai-6cca2.appspot.com",
      messagingSenderId: "624127781219",
      appId: "1:624127781219:web:a580ac6e80ccc26e694b56"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ===== DOM ===== */
    const btnEn       = document.getElementById("btn-en");
    const btnTr       = document.getElementById("btn-tr");
    const backBtn     = document.getElementById("backBtn");
    const logoutBtn   = document.getElementById("logoutBtn");
    const userLabel   = document.getElementById("user-label");
    const pageTitle   = document.getElementById("pageTitle");
    const listEl      = document.getElementById("list");
    const emptyState  = document.getElementById("emptyState");
    const rightsLabel = document.getElementById("rightsLabel");
    const devLabel    = document.getElementById("devLabel");
    const contactLabel= document.getElementById("contactLabel");

    /* ===== i18n ===== */
    const i18n = {
      en:{
        title:"MY READING HISTORY",
        back:"Back",
        logout:"Logout",
        welcome:"Welcome, ",
        typeLabel:"Type",
        dateLabel:"Date",
        seeButton:"View Reading",
        deleteConfirm:"Do you want to delete this reading?",
        deleted:"Reading deleted.",
        noReadings:"No readings found yet.",
        rights:"All Rights Reserved.",
        dev:"Developed by GALAXY ðŸŒŒ",
        contact:"Contact us:",
      },
      tr:{
        title:"FAL GEÃ‡MÄ°ÅžÄ°M",
        back:"Geri",
        logout:"Ã‡Ä±kÄ±ÅŸ",
        welcome:"HoÅŸ geldin, ",
        typeLabel:"TÃ¼r",
        dateLabel:"Tarih",
        seeButton:"FalÄ±nÄ± GÃ¶r",
        deleteConfirm:"Bu fal kaydÄ±nÄ± silmek istiyor musun?",
        deleted:"Fal kaydÄ± silindi.",
        noReadings:"HenÃ¼z kayÄ±tlÄ± bir falÄ±n yok.",
        rights:"TÃ¼m HaklarÄ± SaklÄ±dÄ±r.",
        dev:"GALAXY tarafÄ±ndan geliÅŸtirilmiÅŸtir ðŸŒŒ",
        contact:"Ä°letiÅŸim:",
      }
    };

    let activeLang = localStorage.getItem("myst_lang") || "en";

    function applyLang(){
      const t = i18n[activeLang];
      pageTitle.textContent   = t.title;
      backBtn.textContent     = "â¬… " + t.back;
      logoutBtn.textContent   = t.logout;
      emptyState.textContent  = t.noReadings;
      rightsLabel.textContent = t.rights;
      devLabel.textContent    = t.dev;
      contactLabel.textContent= t.contact;

      btnEn.classList.toggle("active", activeLang === "en");
      btnTr.classList.toggle("active", activeLang === "tr");

      const user = auth.currentUser;
      if(user){
        const name = user.displayName || user.email;
        userLabel.textContent = t.welcome + name;
      }

      // Kart altÄ±ndaki statik label Ã§evirimi yenilemek iÃ§in
      document.querySelectorAll("[data-type-label]").forEach(el=>{
        el.textContent = t.typeLabel + ": " + el.dataset.value;
      });
      document.querySelectorAll("[data-date-label]").forEach(el=>{
        el.textContent = t.dateLabel + ": " + el.dataset.value;
      });
      document.querySelectorAll("[data-btn-see]").forEach(el=>{
        el.textContent = t.seeButton;
      });
    }

    btnEn.addEventListener("click", ()=>{
      activeLang = "en";
      localStorage.setItem("myst_lang","en");
      applyLang();
      renderHistoryForCurrentUser(); // tipi/dili gÃ¼ncel tut
    });

    btnTr.addEventListener("click", ()=>{
      activeLang = "tr";
      localStorage.setItem("myst_lang","tr");
      applyLang();
      renderHistoryForCurrentUser();
    });

    backBtn.addEventListener("click", ()=>{
      window.location.href = "app.html";
    });

    logoutBtn.addEventListener("click", ()=>{
      signOut(auth).then(()=>window.location.href="login.html");
    });

    /* ===== Type Localization ===== */
    const typeMap = [
      {
        key: "coffee",
        en: "AI Coffee Reading",
        tr: "Yapay ZekÃ¢ Kahve FalÄ±",
        variants: ["AI Coffee Reading","Yapay ZekÃ¢ Kahve FalÄ±"]
      },
      {
        key: "palm",
        en: "AI Palm Reading",
        tr: "Yapay ZekÃ¢ El FalÄ±",
        variants: ["AI Palm Reading","Yapay ZekÃ¢ El FalÄ±"]
      },
      {
        key: "tarot",
        en: "AI Tarot Reading",
        tr: "Yapay ZekÃ¢ Tarot FalÄ±",
        variants: ["AI Tarot Reading","Yapay ZekÃ¢ Tarot FalÄ±"]
      },
      {
        key: "energy",
        en: "Energy & Dreams",
        tr: "Enerji & RÃ¼ya Yorumu",
        variants: ["Energy & Dreams","Enerji & RÃ¼ya Yorumu","Energy & Dreams Reading"]
      }
    ];

    function localizeType(rawType, lang){
      if(!rawType) return "";
      for(const m of typeMap){
        if(m.variants.includes(rawType)){
          return m[lang];
        }
      }
      // Bilinmeyen tipse olduÄŸu gibi bÄ±rak
      return rawType;
    }

    /* ===== Date format ===== */
    function formatDate(value){
      let d = null;
      if(!value) return "";
      if(typeof value === "string"){
        const tmp = new Date(value);
        if(!isNaN(tmp.getTime())) d = tmp;
      }else if(typeof value === "object" && typeof value.toDate === "function"){
        d = value.toDate();
      }
      if(!d) return String(value);

      if(activeLang === "tr"){
        return d.toLocaleString("tr-TR",{
          year:"numeric",month:"2-digit",day:"2-digit",
          hour:"2-digit",minute:"2-digit"
        });
      }else{
        return d.toLocaleString("en-GB",{
          year:"numeric",month:"2-digit",day:"2-digit",
          hour:"2-digit",minute:"2-digit"
        });
      }
    }

    /* ===== History Load & Render ===== */
    let lastUserEmail = null;

    async function renderHistoryForCurrentUser(){
      const user = auth.currentUser;
      if(!user) return;

      const t = i18n[activeLang];

      listEl.innerHTML = "";
      emptyState.style.display = "none";

      try{
        const q = query(
          collection(db,"fortunes"),
          where("user","==", user.email),
          orderBy("createdAt","desc")
        );
        const snap = await getDocs(q);

        if(snap.empty){
          emptyState.style.display = "block";
          return;
        }

        snap.forEach(docSnap=>{
          const data = docSnap.data();
          const id   = docSnap.id;

          const rawType   = data.type || "";
          const showType  = localizeType(rawType, activeLang);
          const dateStr   = formatDate(data.createdAt);
          const question  = data.question || "";
          const result    = data.result || "";

          const item = document.createElement("article");
          item.className = "item";
          item.dataset.id = id;

          const main = document.createElement("div");
          main.className = "item-main";

          const typeRow = document.createElement("div");
          typeRow.className = "item-type";
          typeRow.dataset.typeLabel = "1";
          typeRow.dataset.value = showType;
          typeRow.textContent = `${t.typeLabel}: ${showType}`;

          const dateRow = document.createElement("div");
          dateRow.className = "item-date";
          dateRow.dataset.dateLabel = "1";
          dateRow.dataset.value = dateStr;
          dateRow.textContent = `${t.dateLabel}: ${dateStr}`;

          main.appendChild(typeRow);
          main.appendChild(dateRow);

          const actions = document.createElement("div");
          actions.className = "item-actions";

          const seeBtn = document.createElement("button");
          seeBtn.className = "btn-see";
          seeBtn.dataset.btnSee = "1";
          seeBtn.textContent = t.seeButton;
          seeBtn.addEventListener("click", ()=>{
            const title = `${showType}`;
            const qText = question ? `\n\nâš¡ ${activeLang==="tr"?"KullanÄ±cÄ± sorusu / niyeti:":"User question / intention:"}\n${question}` : "";
            alert(title + qText + `\n\nðŸ”® ${activeLang==="tr"?"Yorum:":"Reading:"}\n\n` + result);
          });

          const delBtn = document.createElement("button");
          delBtn.className = "btn-del";
          delBtn.innerHTML = "ðŸ—‘";
          delBtn.addEventListener("click", async ()=>{
            if(!confirm(t.deleteConfirm)) return;
            try{
              await deleteDoc(doc(db,"fortunes",id));
              item.remove();
              if(!listEl.children.length){
                emptyState.style.display = "block";
              }
              alert(t.deleted);
            }catch(err){
              console.error(err);
              alert("Error: " + (err?.message || err));
            }
          });

          actions.appendChild(seeBtn);
          actions.appendChild(delBtn);

          item.appendChild(main);
          item.appendChild(actions);

          listEl.appendChild(item);
        });

      }catch(err){
        console.error(err);
        emptyState.style.display = "block";
        emptyState.textContent = "Error loading history: " + (err?.message || err);
      }
    }

    /* ===== Auth gate ===== */
    onAuthStateChanged(auth, user=>{
      if(!user){
        window.location.href = "login.html";
        return;
      }
      const t = i18n[activeLang];
      const name = user.displayName || user.email;
      userLabel.textContent = t.welcome + name;

      if(user.email !== lastUserEmail){
        lastUserEmail = user.email;
        renderHistoryForCurrentUser();
      }
    });

    applyLang();
  </script>
</body>
</html>
