<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MystAI.ai ‚Äî Astrology & Birth Chart</title>
  <link rel="icon" type="image/png" href="mystai-logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-start:#0d1440;
      --bg-end:#0b0f1f;
      --text:#d8e0ff;
      --muted:#a9b4d0;
      --accent:#f2c84b;
      --card:#151b3d;
    }
    html,body{
      margin:0;padding:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      color:var(--text);
      background:radial-gradient(1400px 800px at 50% -10%, #101a4d 0%, #0b0f1f 85%);
      overflow-x:hidden;
    }

    header{
      position:relative;
      padding:16px 40px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:rgba(10,15,30,0.35);
      backdrop-filter:blur(12px);
      border-bottom:1px solid rgba(255,255,255,0.06);
      z-index:1000;
    }
    .lang-box,.nav-btns{display:flex;gap:10px;align-items:center;}
    .lang-btn{
      font-weight:700;border:0;border-radius:50px;
      padding:7px 13px;cursor:pointer;font-size:13px;
      background:linear-gradient(135deg,#ffd54f,#ffe680);
      color:#111;transition:all .3s ease;
    }
    .lang-btn.secondary{
      background:rgba(255,255,255,.08);
      color:#e6ecff;
      border:1px solid rgba(255,255,255,.16);
    }
    .btn{
      font-weight:700;border:0;border-radius:10px;
      padding:8px 18px;cursor:pointer;
      color:#0b0f1f;background:#ffd54f;
      font-size:14px;transition:all .3s ease;
    }
    .btn:hover,.lang-btn:hover{filter:brightness(1.1);transform:translateY(-2px)}
    .welcome{
      font-weight:600;color:#ffe680;
      text-shadow:0 0 10px rgba(255,220,120,.4);
      margin-right:12px;
    }

    /* Logo */
    .floating-logo{
      position:absolute;left:50%;top:86px;transform:translateX(-50%);
      height:150px;width:auto;pointer-events:none;
      animation:float 6s ease-in-out infinite alternate, glow 6s ease-in-out infinite alternate;
      filter:drop-shadow(0 0 35px rgba(255,230,150,.65)) brightness(1.05);
      z-index:5;
    }
    @keyframes float{from{transform:translate(-50%,-10px)}to{transform:translate(-50%,8px)}}
    @keyframes glow{from{filter:drop-shadow(0 0 25px rgba(255,240,180,.4))}to{filter:drop-shadow(0 0 55px rgba(255,250,200,.8))}}

    /* Layout */
    main{
      max-width:1180px;
      margin:240px auto 60px;
      padding:0 16px 40px;
      display:grid;
      grid-template-columns: minmax(0, 360px) minmax(0, 1fr);
      gap:26px;
    }
    @media(max-width:960px){
      main{
        margin-top:220px;
        grid-template-columns:1fr;
      }
    }

    .panel{
      background:linear-gradient(145deg,rgba(9,12,30,.92),rgba(16,22,54,.96));
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 18px 45px rgba(0,0,0,.6);
      padding:22px 22px 24px;
    }
    .panel-title{
      font-family:'Cinzel',serif;
      font-size:18px;
      color:#ffd76a;
      margin-top:0;
      margin-bottom:8px;
      letter-spacing:.03em;
    }
    .panel-sub{
      font-size:13px;
      color:var(--muted);
      margin-bottom:18px;
      line-height:1.5;
    }

    label{
      font-size:13px;
      color:#cfd6ff;
      margin-bottom:4px;
      display:block;
      text-align:left;
    }
    .field{
      margin-bottom:14px;
      text-align:left;
    }
    input[type="text"],
    input[type="date"],
    input[type="time"],
    textarea{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(4,9,30,.9);
      color:#f3f5ff;
      font-size:14px;
      box-sizing:border-box;
      outline:none;
    }
    textarea{
      resize:vertical;
      min-height:70px;
      max-height:140px;
    }
    input::placeholder,textarea::placeholder{color:#707aa5;}

    .focus-group{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .chip{
      border-radius:999px;
      padding:6px 11px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(9,14,40,.8);
      color:#dfe5ff;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      background:linear-gradient(135deg,#ffd54f,#ffe680);
      color:#111;
      border-color:transparent;
    }

    .mode-tabs{
      display:inline-flex;
      border-radius:999px;
      padding:3px;
      background:rgba(7,11,30,.9);
      border:1px solid rgba(255,255,255,.1);
      margin-bottom:14px;
    }
    .mode-tab{
      border-radius:999px;
      border:none;
      background:transparent;
      color:#b4c3ff;
      font-size:11px;
      padding:6px 12px;
      cursor:pointer;
      white-space:nowrap;
    }
    .mode-tab.active{
      background:linear-gradient(135deg,#ffd54f,#ffe680);
      color:#111;
      font-weight:700;
    }

    .primary-btn{
      width:100%;
      margin-top:10px;
      background:linear-gradient(135deg,#ffd54f,#ffe680);
      color:#111;
      border:none;
      border-radius:14px;
      padding:11px;
      font-weight:800;
      letter-spacing:.03em;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(0,0,0,.7);
      transition:transform .2s ease,box-shadow .2s ease;
    }
    .primary-btn:hover{transform:translateY(-1px);box-shadow:0 14px 36px rgba(0,0,0,.8);}
    .primary-btn:disabled{opacity:.6;cursor:default;transform:none;box-shadow:none;}

    .hint{
      font-size:11px;
      color:#8f97bf;
      margin-top:6px;
      line-height:1.5;
      text-align:left;
    }

    /* Right panel */
    .report-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      gap:10px;
    }
    .report-title{
      font-family:'Cinzel',serif;
      font-size:20px;
      color:#ffd76a;
      margin:0;
    }
    .report-sub{
      font-size:12px;
      color:#aab3dd;
      margin-bottom:15px;
    }

    .chart-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      margin-bottom:14px;
      background:radial-gradient(circle at 50% 0%,rgba(255,255,255,.06),rgba(13,19,48,.4));
      border-radius:16px;
      padding:14px 10px 16px;
      border:1px solid rgba(255,255,255,.08);
    }
    canvas#astroChart{
      max-width:360px;
      max-height:360px;
      width:100%;
      height:auto;
    }
    .chart-meta{
      margin-top:8px;
      font-size:12px;
      color:#cfd6ff;
      text-align:center;
    }
    .download-link{
      margin-top:6px;
      font-size:11px;
      color:#cfe4ff;
      cursor:pointer;
      text-decoration:underline;
    }

    .report-text{
      margin-top:8px;
      padding:12px 12px 14px;
      background:rgba(4,9,30,.9);
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      font-size:14px;
      color:#d9e2ff;
      max-height:260px;
      overflow-y:auto;
      white-space:pre-wrap;
      text-align:left;
    }

    .audio-row{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:#aab3dd;
    }
    .audio-row audio{flex:1;}

    .status{
      margin-top:8px;
      font-size:12px;
      min-height:16px;
      color:#ffcf7a;
    }
    .status.error{color:#ff9b9b;}
    .status.ok{color:#a9ffbf;}

    /* Footer */
    footer{
      margin-top:0;
      padding:36px 0 26px;
      border-top:1px solid rgba(255,255,255,.08);
      color:#aeb6cf;
      font-size:14px;
      text-align:center;
    }
    footer a{color:#cfe4ff;text-decoration:none}
    footer a:hover{color:#ffe680}
    .links{margin-bottom:8px}

    /* Ask MystAI FAB */
    .ask-fab{
      position:fixed; right:18px; bottom:18px; z-index:1200;
      background:linear-gradient(135deg,#ffd54f,#ffe680);
      color:#111; border:none; border-radius:999px; padding:12px 18px;
      font-weight:800; box-shadow:0 8px 30px rgba(0,0,0,.35);
      cursor:pointer; display:flex; align-items:center; gap:8px;
    }
    .ask-fab:hover{filter:brightness(1.06); transform:translateY(-2px)}
    .ask-modal{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; justify-content:center; align-items:center; z-index:1300;
    }
    .ask-card{
      width:min(720px,92vw); background:#0d1a2b;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px; padding:20px;
      box-shadow:0 0 40px rgba(255,215,0,.35);
    }
    .ask-title{margin:0 0 10px; color:#ffd54f; font-family:'Cinzel',serif}
    .ask-row{display:flex; gap:12px; margin-top:10px}
    .ask-row textarea{
      flex:1; height:110px; resize:vertical; border-radius:10px; border:1px solid rgba(255,255,255,.15);
      background:#0b132a; color:#e6ecff; padding:10px; font-family:inherit; font-size:15px;
    }
    .ask-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:10px}
    .ask-btn{background:#ffd54f;color:#111;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .ask-secondary{background:transparent; color:#e6ecff; border:1px solid rgba(255,255,255,.2)}
    .ask-output{margin-top:14px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); padding:12px; border-radius:10px; display:none; text-align:left; white-space:pre-wrap}
    .ask-hint{color:#a9b4d0; font-size:12px; margin-top:6px}
    .spinner{display:none; margin-left:6px}
  </style>
</head>
<body>
  <header>
    <div class="lang-box">
      <button class="lang-btn" id="btn-en">EN</button>
      <button class="lang-btn secondary" id="btn-tr">TR</button>
    </div>
    <div class="nav-btns">
      <span id="user-welcome" class="welcome"></span>
      <button class="btn" id="backBtn" data-i18n="backApp">Back to App</button>
      <button class="btn" id="logoutBtn" data-i18n="logout">Logout</button>
    </div>
  </header>

  <img src="mystai-logo.png" alt="MystAI Logo" class="floating-logo">

  <main>
    <!-- SOL PANEL ‚Äì FORM -->
    <section class="panel" id="formPanel">
      <h2 class="panel-title" data-i18n="birthTitle">Your Birth Details</h2>
      <p class="panel-sub" data-i18n="birthSub">
        Your birth data is kept private and used only to generate your personal astrology report.
      </p>

      <div class="field">
        <label for="birthDate" data-i18n="birthDateLabel">Birth Date</label>
        <input type="date" id="birthDate">
      </div>

      <div class="field">
        <label for="birthTime" data-i18n="birthTimeLabel">Birth Time</label>
        <input type="time" id="birthTime">
      </div>

      <div class="field">
        <label for="birthPlace" data-i18n="birthPlaceLabel">Birth Place (City, Country)</label>
        <input type="text" id="birthPlace" placeholder="ƒ∞zmir, T√ºrkiye">
      </div>

      <div class="field">
        <label for="name" data-i18n="nameLabel">Name (optional)</label>
        <input type="text" id="name" placeholder="Mystic Soul">
      </div>

      <div class="field">
        <label data-i18n="focusLabel">Which themes should MystAI focus on?</label>
        <div class="focus-group">
          <button type="button" class="chip focus-chip" data-key="love" data-i18n="focusLove">Love & Relationships</button>
          <button type="button" class="chip focus-chip" data-key="career" data-i18n="focusCareer">Career & Life Path</button>
          <button type="button" class="chip focus-chip" data-key="money" data-i18n="focusMoney">Money & Abundance</button>
          <button type="button" class="chip focus-chip" data-key="spirit" data-i18n="focusSpirit">Spiritual Growth</button>
        </div>
      </div>

      <div class="field">
        <label for="question" data-i18n="questionLabel">Any specific question or intention?</label>
        <textarea id="question" data-i18n-placeholder="questionPh"
          placeholder="Example: How will my love life and career evolve over the next 12 months?"></textarea>
        <p class="hint" data-i18n="questionHint">
          Example: ‚ÄúHow does my birth chart influence my relationships and career in the coming year?‚Äù or
          ‚ÄúWhich life areas are most highlighted in my chart right now?‚Äù
        </p>
      </div>

      <button class="primary-btn" id="generateBtn" data-i18n="generate">
        Create Astrology Report
      </button>

      <p class="hint" data-i18n="safeNote">
        MystAI is for guidance and insight only, and does not replace professional medical, legal, or financial advice.
      </p>
    </section>

    <!-- SAƒû PANEL ‚Äì HARƒ∞TA + RAPOR -->
    <section class="panel" id="reportPanel">
      <div class="report-header">
        <h2 class="report-title" data-i18n="reportTitle">Your AI Astrology Report</h2>
        <div class="mode-tabs" id="modeTabs">
          <button class="mode-tab active" data-mode="natal" data-i18n="modeNatal">Natal</button>
          <button class="mode-tab" data-mode="solar" data-i18n="modeSolar">Natal + Solar Return</button>
          <button class="mode-tab" data-mode="transit" data-i18n="modeTransit">Natal + Solar + Transits</button>
        </div>
      </div>

      <p class="report-sub" data-i18n="reportSub">
        MystAI will draw a symbolic birth chart and interpret it with AI ‚Äî
        highlighting your key themes, strengths, and current cosmic focus.
      </p>

      <div class="chart-wrap">
        <canvas id="astroChart" width="420" height="420">
          Your browser does not support the astrology chart canvas.
        </canvas>
        <div class="chart-meta" id="chartMeta"></div>
        <div class="download-link" id="downloadChart" data-i18n="downloadChart">
          Download chart as PNG
        </div>
      </div>

      <div class="audio-row">
        <span data-i18n="listenLabel">Listen to your report:</span>
        <audio id="astroAudio" controls></audio>
      </div>

      <div class="report-text" id="astroText"></div>

      <div class="status" id="statusLabel"></div>
    </section>
  </main>

  <footer>
    <div class="links">
      <a href="terms.html" data-i18n="terms">Terms</a> ‚Ä¢ 
      <a href="privacy.html" data-i18n="privacy">Privacy</a> ‚Ä¢ 
      <a href="cookies.html" data-i18n="cookies">Cookies</a> ‚Ä¢ 
      <a href="disclaimer.html" data-i18n="disclaimer">Disclaimer</a>
    </div>
    <p>
      ¬© 2025 MystAI.ai ‚Äî <span data-i18n="rights">All Rights Reserved.</span>
      <span data-i18n="dev">Developed by GALAXY üåå</span><br>
      <a href="mailto:support@mystai.ai">support@mystai.ai</a>
    </p>
  </footer>

  <!-- Ask MystAI FAB -->
  <button class="ask-fab" id="askFab">
    üîÆ <span data-i18n="ask">Ask MystAI</span>
  </button>

  <!-- Ask MystAI Modal -->
  <div class="ask-modal" id="askModal" role="dialog" aria-modal="true" aria-labelledby="askTitle">
    <div class="ask-card">
      <h2 class="ask-title" id="askTitle" data-i18n="askTitle">Ask MystAI üîÆ</h2>
      <div class="ask-row">
        <textarea id="askInput" placeholder="Type your question..."></textarea>
      </div>
      <div class="ask-hint" id="askHint">
        Tip: You can ask about your energy, dreams, love, career, or destiny.
      </div>
      <div class="ask-actions">
        <button class="ask-btn ask-secondary" id="askClose" data-i18n="close">Close</button>
        <button class="ask-btn" id="askSend">
          <span data-i18n="send">Send</span>
          <span class="spinner" id="askSpin">‚è≥</span>
        </button>
      </div>
      <div class="ask-output" id="askOutput"></div>
      <audio id="askAudio" style="display:none;"></audio>
    </div>
  </div>

  <script type="module">
    /* ====== CONFIG ====== */
    const BACKEND_URL = "https://mystai-international-1.onrender.com";

    /* ====== Firebase (auth) ====== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDyiD7GAfOjMbtm-S6pO6XCSRXJclffPL0",
      authDomain: "mystai-6cca2.firebaseapp.com",
      projectId: "mystai-6cca2",
      storageBucket: "mystai-6cca2.appspot.com",
      messagingSenderId: "624127781219",
      appId: "1:624127781219:web:a580ac6e80ccc26e694b56"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const logoutBtn   = document.getElementById('logoutBtn');
    const backBtn     = document.getElementById('backBtn');
    const userWelcome = document.getElementById('user-welcome');

    logoutBtn.addEventListener('click', ()=> {
      signOut(auth).then(()=>window.location.href = "login.html");
    });
    backBtn.addEventListener('click', ()=>window.location.href="app.html");

    onAuthStateChanged(auth, (user)=>{
      if(user){
        const name = user.displayName || user.email;
        userWelcome.textContent = (activeLang === 'tr' ? 'Ho≈ü geldin, ' : 'Welcome, ') + name;
      } else {
        window.location.href = "login.html";
      }
    });

    /* ====== i18n ====== */
    const i18n = {
      en:{
        backApp:"Back to App",
        logout:"Logout",
        birthTitle:"Your Birth Details",
        birthSub:"Your birth data is kept private and used only to generate your personal astrology report.",
        birthDateLabel:"Birth Date",
        birthTimeLabel:"Birth Time",
        birthPlaceLabel:"Birth Place (City, Country)",
        nameLabel:"Name (optional)",
        focusLabel:"Which themes should MystAI focus on?",
        focusLove:"Love & Relationships",
        focusCareer:"Career & Life Path",
        focusMoney:"Money & Abundance",
        focusSpirit:"Spiritual Growth",
        questionLabel:"Any specific question or intention?",
        questionPh:"Example: How will my love life and career evolve over the next 12 months?",
        questionHint:"Example: ‚ÄúHow does my birth chart influence my relationships and career in the coming year?‚Äù or ‚ÄúWhich life areas are most highlighted in my chart right now?‚Äù",
        generate:"Create Astrology Report",
        safeNote:"MystAI is for guidance and insight only, and does not replace professional medical, legal, or financial advice.",
        reportTitle:"Your AI Astrology Report",
        reportSub:"MystAI will draw a symbolic birth chart and interpret it with AI ‚Äî highlighting your key themes, strengths, and current cosmic focus.",
        modeNatal:"Natal",
        modeSolar:"Natal + Solar Return",
        modeTransit:"Natal + Solar + Transits",
        downloadChart:"Download chart as PNG",
        listenLabel:"Listen to your report:",
        terms:"Terms",privacy:"Privacy",cookies:"Cookies",disclaimer:"Disclaimer",
        rights:"All Rights Reserved.",
        dev:"Developed by GALAXY üåå",
        ask:"Ask MystAI",
        askTitle:"Ask MystAI üîÆ",
        send:"Send",
        close:"Close",
        hint:"Tip: You can ask about your energy, dreams, love, career, or destiny.",
        askPlaceholder:"Type your question...",
        statusIdle:"Fill in your birth details and click ‚ÄúCreate Astrology Report‚Äù.",
        statusWorking:"Preparing your personalized astrology report...",
        statusError:"An error occurred while creating your report. Please try again.",
        statusOk:"Your report has been created.",
        missingFields:"Please enter your birth date, time and place.",
        dlSuccess:"Your chart image is ready.",
        dlError:"Chart could not be downloaded."
      },
      tr:{
        backApp:"Uygulamaya D√∂n",
        logout:"√áƒ±kƒ±≈ü Yap",
        birthTitle:"Doƒüum Bilgilerin",
        birthSub:"Doƒüum verilerin gizli tutulur ve sadece ki≈üisel astroloji raporunu olu≈üturmak i√ßin kullanƒ±lƒ±r.",
        birthDateLabel:"Doƒüum Tarihi",
        birthTimeLabel:"Doƒüum Saati",
        birthPlaceLabel:"Doƒüum Yeri (≈ûehir, √úlke)",
        nameLabel:"ƒ∞smin (opsiyonel)",
        focusLabel:"MystAI hangi alanlara odaklansƒ±n?",
        focusLove:"A≈ük & ƒ∞li≈ükiler",
        focusCareer:"Kariyer & Ya≈üam Yolu",
        focusMoney:"Para & Bolluk",
        focusSpirit:"Ruhsal Geli≈üim",
        questionLabel:"√ñzel bir sorun ya da niyetin var mƒ±?",
        questionPh:"√ñrnek: √ñn√ºm√ºzdeki 12 ay a≈ük ve kariyerim nasƒ±l ≈üekilleniyor?",
        questionHint:"√ñrnek: ‚ÄúDoƒüum haritam a≈ük hayatƒ±mƒ± ve kariyerimi √∂n√ºm√ºzdeki yƒ±l nasƒ±l etkiliyor?‚Äù veya ‚ÄúHaritamda ≈üu anda en √ßok hangi alanlar vurgulanƒ±yor?‚Äù",
        generate:"Astroloji Raporu Olu≈ütur",
        safeNote:"MystAI yalnƒ±zca rehberlik ve farkƒ±ndalƒ±k i√ßindir; tƒ±bbi, hukuki veya finansal profesyonel danƒ±≈ümanƒ±n yerini almaz.",
        reportTitle:"Yapay Zek√¢ Astroloji Raporun",
        reportSub:"MystAI sembolik bir doƒüum haritasƒ± √ßizer ve yapay zek√¢ ile yorumlayarak hayatƒ±ndaki ana temalarƒ±, g√º√ßl√º y√∂nlerini ve g√∂ksel odak noktalarƒ±nƒ± vurgular.",
        modeNatal:"Natal",
        modeSolar:"Natal + Solar Return",
        modeTransit:"Natal + Solar + Transitler",
        downloadChart:"Haritayƒ± PNG olarak indir",
        listenLabel:"Raporunu dinle:",
        terms:"≈ûartlar",privacy:"Gizlilik",cookies:"√áerezler",disclaimer:"Sorumluluk Reddi",
        rights:"T√ºm Haklarƒ± Saklƒ±dƒ±r.",
        dev:"GALAXY tarafƒ±ndan geli≈ütirilmi≈ütir üåå",
        ask:"MystAI'ye Sor",
        askTitle:"MystAI'ye Sor üîÆ",
        send:"G√∂nder",
        close:"Kapat",
        hint:"ƒ∞pucu: Enerji, r√ºyalar, a≈ük, kariyer ya da kaderin hakkƒ±nda sorular sorabilirsin.",
        askPlaceholder:"Sorunu yaz...",
        statusIdle:"Doƒüum bilgilerini doldur ve ‚ÄúAstroloji Raporu Olu≈ütur‚Äùa tƒ±kla.",
        statusWorking:"Ki≈üisel astroloji raporun hazƒ±rlanƒ±yor...",
        statusError:"Rapor olu≈üturulurken bir hata olu≈ütu. L√ºtfen tekrar dene.",
        statusOk:"Raporun hazƒ±r.",
        missingFields:"L√ºtfen doƒüum tarihi, saati ve yerini gir.",
        dlSuccess:"Harita g√∂rselin hazƒ±r.",
        dlError:"Harita indirilemedi."
      }
    };

    let activeLang = localStorage.getItem("myst_lang") || "en";

    function applyI18n(){
      const dict = i18n[activeLang];
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const key = el.getAttribute("data-i18n");
        if(dict[key]) el.textContent = dict[key];
      });
      const q = document.getElementById("question");
      q.placeholder = dict.questionPh;
      document.getElementById("askInput").placeholder = dict.askPlaceholder;
      document.getElementById("askHint").textContent = dict.hint;
      document.getElementById("btn-en").classList.toggle("secondary", activeLang!=="en");
      document.getElementById("btn-tr").classList.toggle("secondary", activeLang!=="tr");
      document.getElementById("statusLabel").textContent = dict.statusIdle;

      if(auth.currentUser){
        const name = auth.currentUser.displayName || auth.currentUser.email;
        userWelcome.textContent = (activeLang === 'tr' ? 'Ho≈ü geldin, ' : 'Welcome, ') + name;
      }
    }

    document.getElementById("btn-en").addEventListener("click",()=>{activeLang="en";localStorage.setItem("myst_lang","en");applyI18n();});
    document.getElementById("btn-tr").addEventListener("click",()=>{activeLang="tr";localStorage.setItem("myst_lang","tr");applyI18n();});
    applyI18n();

    /* ====== Focus chips ====== */
    document.querySelectorAll(".focus-chip").forEach(chip=>{
      chip.addEventListener("click",()=>chip.classList.toggle("active"));
    });

    /* ====== Mode tabs ====== */
    let currentMode = "natal";
    document.querySelectorAll(".mode-tab").forEach(tab=>{
      tab.addEventListener("click",()=>{
        document.querySelectorAll(".mode-tab").forEach(t=>t.classList.remove("active"));
        tab.classList.add("active");
        currentMode = tab.dataset.mode;
      });
    });

    /* ====== Astrology chart drawing (symbolic) ====== */
    const canvas = document.getElementById("astroChart");
    const ctx = canvas.getContext ? canvas.getContext("2d") : null;

    function hashString(str){
      let h = 0;
      for(let i=0;i<str.length;i++){
        h = (h*31 + str.charCodeAt(i)) >>> 0;
      }
      return h;
    }

    function drawAstroChart(birthDate,birthTime,birthPlace){
      if(!ctx) return;
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0,0,w,h);

      const cx = w/2;
      const cy = h/2;
      const outer = Math.min(w,h)/2 - 12;
      const middle = outer*0.78;
      const inner = outer*0.45;

      // background glow
      const grad = ctx.createRadialGradient(cx,cy,inner*0.3,cx,cy,outer);
      grad.addColorStop(0,"rgba(35,46,120,0.9)");
      grad.addColorStop(1,"rgba(5,9,40,1)");
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(cx,cy,outer+6,0,Math.PI*2);
      ctx.fill();

      // circles
      ctx.strokeStyle = "rgba(255,255,255,0.2)";
      ctx.lineWidth = 1.2;
      [outer,middle,inner].forEach(r=>{
        ctx.beginPath();
        ctx.arc(cx,cy,r,0,Math.PI*2);
        ctx.stroke();
      });

      // 12 houses
      ctx.save();
      ctx.translate(cx,cy);
      for(let i=0;i<12;i++){
        const angle = (Math.PI*2/12)*i - Math.PI/2;
        ctx.beginPath();
        ctx.moveTo(inner,0);
        ctx.lineTo(outer,0);
        ctx.stroke();
        ctx.rotate(Math.PI*2/12);
      }
      ctx.restore();

      // zodiac labels
      const zodiacs = ["‚ôàÔ∏é","‚ôâÔ∏é","‚ôäÔ∏é","‚ôãÔ∏é","‚ôåÔ∏é","‚ôçÔ∏é","‚ôéÔ∏é","‚ôèÔ∏é","‚ôêÔ∏é","‚ôëÔ∏é","‚ôíÔ∏é","‚ôìÔ∏é"];
      ctx.font = "16px Cinzel, serif";
      ctx.fillStyle = "rgba(255,229,180,0.96)";
      for(let i=0;i<12;i++){
        const a = (Math.PI*2/12)*i - Math.PI/2 + Math.PI/12;
        const r = (outer+middle)/2 + 4;
        const x = cx + Math.cos(a)*r;
        const y = cy + Math.sin(a)*r + 5;
        ctx.fillText(zodiacs[i],x-9,y);
      }

      // planets (symbolic)
      const seed = `${birthDate}|${birthTime}|${birthPlace}`;
      let hval = hashString(seed);
      const planets = [
        {key:"Sun",   symbol:"‚òâ"},
        {key:"Moon",  symbol:"‚òæ"},
        {key:"Merc",  symbol:"‚òø"},
        {key:"Venus", symbol:"‚ôÄ"},
        {key:"Mars",  symbol:"‚ôÇ"},
        {key:"Jup",   symbol:"‚ôÉ"},
        {key:"Sat",   symbol:"‚ôÑ"},
        {key:"Ura",   symbol:"‚ôÖ"},
        {key:"Nep",   symbol:"‚ôÜ"},
        {key:"Plu",   symbol:"‚ôá"},
        {key:"ASC",   symbol:"ASC"},
        {key:"MC",    symbol:"MC"}
      ];

      ctx.font = "11px system-ui, sans-serif";
      planets.forEach((p,idx)=>{
        hval = (hval*1664525 + 1013904223) >>> 0;
        const deg = hval % 360;
        const rad = (deg*Math.PI)/180;
        const r = inner + (idx%3)*((middle-inner)/3) + 10;
        const px = cx + Math.cos(rad)*r;
        const py = cy + Math.sin(rad)*r;

        ctx.fillStyle = "rgba(255,255,255,0.95)";
        ctx.beginPath();
        ctx.arc(px,py,4,0,Math.PI*2);
        ctx.fill();

        ctx.fillStyle = "rgba(255,229,180,0.95)";
        ctx.fillText(p.symbol,px+6,py+3);
      });
    }

    function updateChartMeta(date,time,place){
      const meta = document.getElementById("chartMeta");
      if(!date || !time || !place){
        meta.textContent = "";
        return;
      }
      if(activeLang === "tr"){
        meta.textContent = `Doƒüum tarihi: ${date} ‚Ä¢ Doƒüum saati: ${time} ‚Ä¢ Doƒüum yeri: ${place}`;
      }else{
        meta.textContent = `Birth date: ${date} ‚Ä¢ Time: ${time} ‚Ä¢ Place: ${place}`;
      }
    }

    // initial empty chart
    drawAstroChart("","","");
    updateChartMeta("","","");

    /* ====== Download chart as PNG ====== */
    document.getElementById("downloadChart").addEventListener("click",()=>{
      try{
        const link = document.createElement("a");
        link.download = "mystai_birth_chart.png";
        link.href = canvas.toDataURL("image/png");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        const dict = i18n[activeLang];
        document.getElementById("statusLabel").textContent = dict.dlSuccess;
        document.getElementById("statusLabel").className = "status ok";
      }catch(e){
        const dict = i18n[activeLang];
        document.getElementById("statusLabel").textContent = dict.dlError;
        document.getElementById("statusLabel").className = "status error";
      }
    });

    /* ====== Astrology report generation ====== */
    const generateBtn = document.getElementById("generateBtn");
    const astroText   = document.getElementById("astroText");
    const astroAudio  = document.getElementById("astroAudio");
    const statusLabel = document.getElementById("statusLabel");

    generateBtn.addEventListener("click", async ()=>{
      const birthDate  = document.getElementById("birthDate").value;
      const birthTime  = document.getElementById("birthTime").value;
      const birthPlace = document.getElementById("birthPlace").value.trim();
      const name       = document.getElementById("name").value.trim();
      const question   = document.getElementById("question").value.trim();

      const dict = i18n[activeLang];

      if(!birthDate || !birthTime || !birthPlace){
        alert(dict.missingFields);
        return;
      }

      // se√ßili odak alanlarƒ±
      const focusKeys = [];
      document.querySelectorAll(".focus-chip.active").forEach(ch=>{
        focusKeys.push(ch.dataset.key);
      });

      drawAstroChart(birthDate,birthTime,birthPlace);
      updateChartMeta(birthDate,birthTime,birthPlace);

      let focusText;
      if(activeLang === "tr"){
        const map = {
          love:"a≈ük ve ili≈ükiler",
          career:"kariyer ve ya≈üam yolu",
          money:"para, bolluk ve maddi alanlar",
          spirit:"ruhsel geli≈üim ve i√ßsel yolculuk"
        };
        focusText = focusKeys.map(k=>map[k]).filter(Boolean).join(", ") || "t√ºm ya≈üam alanlarƒ±";
      }else{
        const map = {
          love:"love and relationships",
          career:"career and life path",
          money:"money, abundance and material matters",
          spirit:"spiritual growth and inner journey"
        };
        focusText = focusKeys.map(k=>map[k]).filter(Boolean).join(", ") || "all life areas";
      }

      let modeText;
      if(activeLang==="tr"){
        modeText =
          currentMode==="natal"   ? "Sadece Natal harita" :
          currentMode==="solar"   ? "Natal + Solar Return (g√ºne≈ü d√∂n√º≈ü√º)" :
                                     "Natal + Solar Return + Transit etkileri";
      }else{
        modeText =
          currentMode==="natal"   ? "Natal chart only" :
          currentMode==="solar"   ? "Natal + Solar Return" :
                                     "Natal + Solar Return + transits";
      }

      const displayName = name || (auth.currentUser ? (auth.currentUser.displayName || auth.currentUser.email) : "");

      let prompt;
      if(activeLang === "tr"){
        prompt =
          "Sen MystAI adlƒ± dijital fal kapƒ±sƒ±nda √ßalƒ±≈üan, deneyimli bir batƒ± astroloƒüusun. " +
          "Astrolojiyi psikoloji ve ruhsal geli≈üimle birle≈ütirerek, kullanƒ±cƒ±ya hem ger√ßek√ßi hem umut veren, sakin ve profesyonel bir dille rehberlik edersin. " +
          "Doƒüum haritasƒ±nƒ±, sembolik olarak √ßizilmi≈ü bir √ßark √ºzerinden okuyorsun. " +
          "A≈üaƒüƒ±daki doƒüum bilgilerine g√∂re ayrƒ±ntƒ±lƒ± bir ASTROLOJƒ∞ RAPORU yaz:\n\n" +
          `- ƒ∞sim (varsa): ${displayName || "Belirtilmedi"}\n` +
          `- Doƒüum tarihi: ${birthDate}\n` +
          `- Doƒüum saati: ${birthTime}\n` +
          `- Doƒüum yeri: ${birthPlace}\n` +
          `- Se√ßilen odak alanlarƒ±: ${focusText}\n` +
          `- Harita modu: ${modeText}\n` +
          (question ? `- Kullanƒ±cƒ±nƒ±n sorusu / niyeti: ${question}\n` : "") +
          "\nL√ºtfen raporu a≈üaƒüƒ±daki ba≈ülƒ±klarla, samimi ama profesyonel bir tonda yaz:\n" +
          "1) Kƒ±sa √∂zet\n" +
          "2) Ki≈üilik & karakter √∂z√º (G√ºne≈ü, Ay, y√ºkselen temalarƒ±)\n" +
          "3) Ya≈üam amacƒ± ve kader temalarƒ±\n" +
          "4) A≈ük, ili≈ükiler ve evlilik potansiyeli\n" +
          "5) Para, bolluk ve kariyer alanƒ±\n" +
          "6) Ruhsal geli≈üim, karmik dersler ve i√ßsel yolculuk\n" +
          "7) 12 ev √ºzerinden genel bir tur (her evi kƒ±saca deƒüin)\n" +
          "8) √ñn√ºm√ºzdeki 12 aya dair g√∂ksel iklim / yƒ±ldƒ±zname yorumu\n\n" +
          "Korkutucu veya umutsuz c√ºmlelerden ka√ßƒ±n; ger√ßek√ßi ama yapƒ±cƒ±, cesaretlendirici ve net ol.";
      }else{
        prompt =
          "You are an experienced Western astrologer working as MystAI, a digital oracle. " +
          "You combine astrology with psychology and spiritual insight, speaking in a warm, calm and professional tone. " +
          "You are reading a symbolically drawn birth chart wheel. " +
          "Based on the following birth details, write a detailed ASTROLOGY REPORT:\n\n" +
          `- Name (if any): ${displayName || "Not provided"}\n` +
          `- Birth date: ${birthDate}\n` +
          `- Birth time: ${birthTime}\n` +
          `- Birth place: ${birthPlace}\n` +
          `- Focus themes: ${focusText}\n` +
          `- Chart mode: ${modeText}\n` +
          (question ? `- User's question / intention: ${question}\n` : "") +
          "\nPlease structure the report with these sections, in clear paragraphs:\n" +
          "1) Short overview\n" +
          "2) Core personality & character (Sun, Moon, Rising themes)\n" +
          "3) Life purpose and destiny themes\n" +
          "4) Love, relationships and marriage potential\n" +
          "5) Money, abundance and career\n" +
          "6) Spiritual growth, karmic lessons and inner journey\n" +
          "7) Quick tour through the 12 houses (touch each briefly)\n" +
          "8) General forecast for the next 12 months\n\n" +
          "Avoid scary or hopeless statements; be realistic yet encouraging, constructive and specific.";
      }

      try{
        generateBtn.disabled = true;
        astroText.textContent = "";
        astroAudio.src = "";
        statusLabel.textContent = dict.statusWorking;
        statusLabel.className = "status";

        const res = await fetch(`${BACKEND_URL}/predict`, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({ user_input: prompt, reading_type:"general" })
        });

        if(!res.ok){
          throw new Error("HTTP " + res.status);
        }

        const data = await res.json();

        if(data.error){
          throw new Error(data.error);
        }

        const text = data.text || "";
        const audioPath = data.audio;

        astroText.textContent = text || (activeLang==="tr" ? "Rapor alƒ±namadƒ±." : "No report text received.");
        statusLabel.textContent = dict.statusOk;
        statusLabel.className = "status ok";

        if(audioPath){
          const audioURL = audioPath.startsWith("http") ? audioPath : `${BACKEND_URL}${audioPath}`;
          astroAudio.src = audioURL;
        }
      }catch(err){
        console.error(err);
        statusLabel.textContent = dict.statusError;
        statusLabel.className = "status error";
      }finally{
        generateBtn.disabled = false;
      }
    });

    /* ====== Ask MystAI (alt saƒü buton) ====== */
    const askFab    = document.getElementById('askFab');
    const askModal  = document.getElementById('askModal');
    const askClose  = document.getElementById('askClose');
    const askSend   = document.getElementById('askSend');
    const askInput  = document.getElementById('askInput');
    const askOutput = document.getElementById('askOutput');
    const askSpin   = document.getElementById('askSpin');
    const askAudio  = document.getElementById('askAudio');

    askFab.addEventListener('click', ()=> {
      askModal.style.display='flex';
      askInput.focus();
    });
    askClose.addEventListener('click', ()=> {
      askModal.style.display='none';
      askOutput.style.display='none';
      askInput.value='';
      askAudio.pause(); askAudio.currentTime=0; askAudio.src='';
    });
    askModal.addEventListener('click', (e)=>{
      if(e.target === askModal){ askClose.click(); }
    });

    askSend.addEventListener('click', async ()=>{
      const q = askInput.value.trim();
      const dict = i18n[activeLang];

      if(!q){
        alert(activeLang==='tr' ? 'L√ºtfen bir soru yazƒ±n.' : 'Please type a question.');
        return;
      }

      askSpin.style.display='inline-block';
      askSend.disabled = true;
      askOutput.style.display='none';
      askOutput.textContent = '';

      try{
        if(!BACKEND_URL){
          askOutput.style.display='block';
          askOutput.textContent = activeLang==='tr'
            ? 'Backend adresi yapƒ±landƒ±rƒ±lmadƒ±.'
            : 'Backend URL is not configured.';
          return;
        }

        const res = await fetch(`${BACKEND_URL}/predict`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ user_input: q, reading_type:"general" })
        });

        if(!res.ok){
          throw new Error('Request failed: ' + res.status);
        }

        const data = await res.json();
        const text = data?.text || (activeLang==='tr'?'Yanƒ±t alƒ±namadƒ±.':'No response.');
        const audioPath = data?.audio;

        askOutput.style.display='block';
        askOutput.textContent = text;

        if(audioPath){
          const audioURL = audioPath.startsWith('http') ? audioPath : `${BACKEND_URL}${audioPath}`;
          askAudio.src = audioURL;
          askAudio.play().catch(()=>{});
        }
      }catch(err){
        askOutput.style.display='block';
        askOutput.textContent = (activeLang==='tr'?'Hata: ':'Error: ') + (err?.message||err);
      }finally{
        askSpin.style.display='none';
        askSend.disabled = false;
      }
    });
  </script>
</body>
</html>
